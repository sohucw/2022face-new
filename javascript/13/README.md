# 介绍下重绘和回流（Repaint & Reflow），以及如何进行优化？

## 浏览器渲染机制

- 浏览器采用流式布局模型（Flow Based Layout）；
- 浏览器会把 `HTML` 解析成 `DOM`，把 `CSS` 解析成 `CSSOM`,`DOM` 和 `CSSOM` 合并就产生了渲染树（`Render Tree`）；
- 有了 `RenderTree`，我们就知道了所有节点的样式，然后计算他们在页面上的大小和位置，最后把节点绘制到页面上；
- 由于浏览器使用流式布局，对 `Render Tree` 的计算通常只需要遍历一次就可以完成，但 `table` 及其内部元素除外，他们可能需要多次计算，通常要花 3 倍于同等元素的时间，这也是为什么要避免使用 `table` 布局的原因之一；

## 重绘

由于节点的集合属性发生改变或者由于样式改变而不会影响布局的，成为重绘，例如 `outline、visibility、color、background-color` 等，重绘的代价是高昂的，因此浏览器必须验证 `DOM` 树上其他节点元素的可见性。

## 回流

回流是布局或者几何属性需要改变就称为回流。回流是影响浏览器性能的关键因素，因为其变化涉及到部分页面（或是整个页面）的布局更新。一个元素的回流可能会导致其素有子元素以及 `DOM` 中紧随其后的节点、祖先节点元素的随后的回流。大部分的回流将导致页面的重新渲染。

回流必定会发生重绘，重绘不一定会引发回流。

## 浏览器优化

现代浏览器大多是通过队列机制来批量更新布局，浏览器会把修改操作放在队列中，至少一个浏览器刷新（即16.6ms）才会清空队列，但当你获取布局信息的时候，队列中可能会有影响这些属性或方法返回值的操作，即使没有，浏览器也会强制清空队列，触发回流和重绘来确保返回正确的值。

例如 `offsetTop、clientTop、scrollTop、getComputedStyle()、width、height、getBoundingClientRect()`，应避免频繁使用这些属性，他们都会强制渲染刷新队列。

## 减少重绘和回流

1. CSS
  - 使用 `transform` 代替 `top`；
  - 使用 `visibility` 替换 `display: none`，前者引起重绘，后者引发回流；
  - 避免使用 `table` 布局；
  - 尽可能在 `DOM` 树的最末端改变 `class`；
  - 避免设置多层内联样式，CSS 选择符从右往左匹配查找，避免节点层级过多；
  - 将动画效果应用到 `position` 属性为 `absolute` 或 `fixed` 的元素上，避免影响其他元素的布局；
  - 避免使用 `CSS` 表达式，可能会引发回流；
  - CSS 硬件加速；
2. Javascript
  - 避免频繁操作样式，修改 `class` 最好；
  - 避免频繁操作 `DOM`，合并多次修改为一次；
  - 避免频繁读取会引发回流/重绘的属性，将结果缓存；
  - 对具有复杂动画的元素使用绝对定位，使它脱离文档流；